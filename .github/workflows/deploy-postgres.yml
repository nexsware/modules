name: Provision PostgreSQL Database (Reusable)

on:
  workflow_call:
    inputs:
      region:
        description: 'Linode Region'
        required: true
        type: string
      database_type:
        description: 'Linode Database Plan Type'
        required: true
        type: string
      engine_id:
        description: 'PostgreSQL Engine ID (e.g., postgresql/18, postgresql/16.3)'
        required: true
        type: string
      environment:
        description: 'Deployment environment (e.g., test, prod)'
        required: true
        type: string
      application_name:
        description: 'Application Name'
        required: false
        type: string
        default: ''
      cluster_size:
        description: 'Number of nodes in the database cluster'
        required: false
        type: number
        default: 1
      instance_id:
        description: 'Linode Instance ID to allow database access (will fetch its IP)'
        required: false
        type: string
        default: ''
      allow_list:
        description: 'Comma-separated list of IP addresses or CIDR blocks to allow access'
        required: false
        type: string
        default: ''
      databases:
        description: 'Comma-separated list of additional databases to create'
        required: false
        type: string
        default: ''
      service_account_username:
        description: 'Service account username to create'
        required: false
        type: string
        default: 'srv_account'
      update_frequency:
        description: 'Maintenance window frequency (weekly, monthly)'
        required: false
        type: string
        default: 'weekly'
      update_duration:
        description: 'Maintenance window duration in hours'
        required: false
        type: number
        default: 4
      update_hour_of_day:
        description: 'Maintenance window hour of day (0-23)'
        required: false
        type: number
        default: 22
      update_day_of_week:
        description: 'Maintenance window day of week (1=Monday, 7=Sunday)'
        required: false
        type: number
        default: 2
      terraform_dir:
        description: 'Directory containing Terraform configuration'
        required: false
        type: string
        default: 'modules/terraform/linode/postgres'
    secrets:
      LINODE_TOKEN:
        description: 'Linode API Token'
        required: true
      SERVICE_ACCOUNT:
        description: 'Service account username (overrides service_account_username input if provided)'
        required: false
      SERVICE_ACCOUNT_PASSWORD:
        description: 'Password for the service account user'
        required: false
    outputs:
      database_id:
        description: 'The ID of the created database cluster'
        value: ${{ jobs.provision-postgres.outputs.database_id }}
      database_host:
        description: 'The host/endpoint of the database'
        value: ${{ jobs.provision-postgres.outputs.database_host }}
      database_port:
        description: 'The port of the database'
        value: ${{ jobs.provision-postgres.outputs.database_port }}
      connection_string:
        description: 'The connection string for the database (without password)'
        value: ${{ jobs.provision-postgres.outputs.connection_string }}
      root_username:
        description: 'The root username for the database'
        value: ${{ jobs.provision-postgres.outputs.root_username }}

jobs:
  provision-postgres:
    runs-on: ubuntu-latest
    if: ${{ inputs.environment != 'prod' || github.ref == 'refs/heads/main' }}
    environment: ${{ inputs.environment }}
    outputs:
      database_id: ${{ steps.terraform-apply.outputs.database_id }}
      database_host: ${{ steps.terraform-apply.outputs.database_host }}
      database_port: ${{ steps.terraform-apply.outputs.database_port }}
      connection_string: ${{ steps.terraform-apply.outputs.connection_string }}
      root_username: ${{ steps.terraform-apply.outputs.root_username }}
    steps:
      - name: Checkout Terraform Modules
        uses: actions/checkout@v4
        with:
          repository: nexsware/modules
          path: modules

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          terraform_version: '1.6.0'
          terraform_wrapper: false

      - name: Get Instance IP (if instance_id provided)
        id: get-instance-ip
        run: |
          if [ -n "${{ inputs.instance_id }}" ]; then
            echo "Fetching IP address for instance ID: ${{ inputs.instance_id }}"
            INSTANCE_IP=$(curl -s -H "Authorization: Bearer ${{ secrets.LINODE_TOKEN }}" \
              "https://api.linode.com/v4/linode/instances/${{ inputs.instance_id }}" | \
              jq -r '.ipv4[0]')
            echo "Instance IP: $INSTANCE_IP"
            echo "instance_ip=${INSTANCE_IP}" >> $GITHUB_OUTPUT
          else
            echo "No instance_id provided"
            echo "instance_ip=" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Allow List
        id: prepare-allow-list
        run: |
          COMBINED_IPS=""

          # Add instance IP if available
          if [ -n "${{ steps.get-instance-ip.outputs.instance_ip }}" ]; then
            COMBINED_IPS="${{ steps.get-instance-ip.outputs.instance_ip }}/32"
          fi

          # Add custom allow_list IPs
          if [ -n "${{ inputs.allow_list }}" ]; then
            if [ -n "$COMBINED_IPS" ]; then
              COMBINED_IPS="${COMBINED_IPS},${{ inputs.allow_list }}"
            else
              COMBINED_IPS="${{ inputs.allow_list }}"
            fi
          fi

          # Convert to JSON array
          if [ -z "$COMBINED_IPS" ]; then
            echo "allow_list_json=[]" >> $GITHUB_OUTPUT
          else
            IFS=',' read -ra IPS <<< "$COMBINED_IPS"
            ALLOW_LIST_JSON="["
            for i in "${!IPS[@]}"; do
              # Trim whitespace
              IP=$(echo "${IPS[$i]}" | xargs)
              # Add /32 if no CIDR notation
              if [[ ! "$IP" =~ / ]]; then
                IP="${IP}/32"
              fi
              ALLOW_LIST_JSON+="\"${IP}\""
              if [ $i -lt $(( ${#IPS[@]} - 1 )) ]; then
                ALLOW_LIST_JSON+=","
              fi
            done
            ALLOW_LIST_JSON+="]"
            echo "allow_list_json=$ALLOW_LIST_JSON" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Databases List
        id: prepare-databases
        run: |
          if [ -z "${{ inputs.databases }}" ]; then
            echo "databases_json=[]" >> $GITHUB_OUTPUT
          else
            # Convert comma-separated databases to JSON array
            IFS=',' read -ra DBS <<< "${{ inputs.databases }}"
            DATABASES_JSON="["
            for i in "${!DBS[@]}"; do
              DB=$(echo "${DBS[$i]}" | xargs)
              DATABASES_JSON+="\"${DB}\""
              if [ $i -lt $(( ${#DBS[@]} - 1 )) ]; then
                DATABASES_JSON+=","
              fi
            done
            DATABASES_JSON+="]"
            echo "databases_json=$DATABASES_JSON" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Database Users
        id: prepare-users
        run: |
          # Create service account user if password is provided
          if [ -n "${{ secrets.SERVICE_ACCOUNT_PASSWORD }}" ]; then
            # Use SERVICE_ACCOUNT secret if provided, otherwise use input
            if [ -n "${{ secrets.SERVICE_ACCOUNT }}" ]; then
              USERNAME="${{ secrets.SERVICE_ACCOUNT }}"
            else
              USERNAME="${{ inputs.service_account_username }}"
            fi

            # Create HCL map for service account
            cat > users.hcl <<EOF
          {
            "${USERNAME}" = {
              password = "${{ secrets.SERVICE_ACCOUNT_PASSWORD }}"
              roles    = []
            }
          }
          EOF
            echo "users_hcl=$(cat users.hcl)" >> $GITHUB_OUTPUT
            rm users.hcl
          else
            echo "users_hcl={}" >> $GITHUB_OUTPUT
          fi

      - name: Create Terraform Variables File
        working-directory: ${{ inputs.terraform_dir }}
        run: |
          cat > terraform.tfvars <<EOFMAIN
          label = "${{ inputs.environment }}-${{ inputs.application_name }}-postgres"
          engine_id = "${{ inputs.engine_id }}"
          region = "${{ inputs.region }}"
          type = "${{ inputs.database_type }}"
          allow_list = ${{ steps.prepare-allow-list.outputs.allow_list_json }}
          cluster_size = ${{ inputs.cluster_size }}
          update_duration = ${{ inputs.update_duration }}
          update_frequency = "${{ inputs.update_frequency }}"
          update_hour_of_day = ${{ inputs.update_hour_of_day }}
          update_day_of_week = ${{ inputs.update_day_of_week }}
          databases = ${{ steps.prepare-databases.outputs.databases_json }}
          database_users = ${{ steps.prepare-users.outputs.users_hcl }}
          linode_token = "${{ secrets.LINODE_TOKEN }}"
          create_resources = false
          EOFMAIN

      - name: Debug - Show Generated Terraform Variables
        working-directory: ${{ inputs.terraform_dir }}
        run: |
          echo "=== Current directory: $(pwd) ==="
          echo "=== Files in directory: ==="
          ls -la
          echo "=== Generated terraform.tfvars ==="
          if [ -f terraform.tfvars ]; then
            cat terraform.tfvars | sed 's/linode_token = .*/linode_token = "***REDACTED***"/'
          else
            echo "ERROR: terraform.tfvars not found!"
          fi
          echo "==================================="

      - name: Terraform Init
        working-directory: ${{ inputs.terraform_dir }}
        run: terraform init

      - name: Terraform Apply - Create Database Only
        id: terraform-apply
        working-directory: ${{ inputs.terraform_dir }}
        run: |
          # First apply: create managed database only (skip resources that need connectivity)
          terraform apply -auto-approve -var="create_resources=false"
          echo "database_id=$(terraform output -raw database_id)" >> $GITHUB_OUTPUT
          echo "database_host=$(terraform output -raw database_host)" >> $GITHUB_OUTPUT
          echo "database_port=$(terraform output -raw database_port)" >> $GITHUB_OUTPUT
          echo "connection_string=$(terraform output -raw connection_string)" >> $GITHUB_OUTPUT
          echo "root_username=$(terraform output -raw root_username)" >> $GITHUB_OUTPUT

      - name: Get GitHub Runner IP
        id: runner-ip
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "runner_ip=$RUNNER_IP" >> $GITHUB_OUTPUT
          echo "GitHub Actions Runner IP: $RUNNER_IP"

      - name: Add Runner IP to Database Allow List
        run: |
          DATABASE_ID="${{ steps.terraform-apply.outputs.database_id }}"
          RUNNER_IP="${{ steps.runner-ip.outputs.runner_ip }}"

          echo "Adding GitHub Runner IP ($RUNNER_IP) to database allow list..."

          # Get current allow list
          CURRENT_ALLOW_LIST=$(curl -s -H "Authorization: Bearer ${{ secrets.LINODE_TOKEN }}" \
            "https://api.linode.com/v4/databases/postgresql/instances/${DATABASE_ID}" | \
            jq -r '.allow_list | join(",")')

          # Add runner IP to allow list
          NEW_ALLOW_LIST="${CURRENT_ALLOW_LIST},${RUNNER_IP}/32"

          # Update database allow list
          curl -X PUT \
            -H "Authorization: Bearer ${{ secrets.LINODE_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"allow_list\": [$(echo $NEW_ALLOW_LIST | sed 's/,/","/g' | sed 's/^/"/;s/$/"/'))]}" \
            "https://api.linode.com/v4/databases/postgresql/instances/${DATABASE_ID}"

          echo "Runner IP added to allow list. Waiting for firewall to update..."
          sleep 30

      - name: Wait for DNS Propagation
        run: |
          DATABASE_HOST="${{ steps.terraform-apply.outputs.database_host }}"

          echo "Waiting for DNS propagation for $DATABASE_HOST..."

          for i in {1..30}; do
            if nslookup "$DATABASE_HOST" > /dev/null 2>&1; then
              echo "DNS resolved successfully!"
              break
            fi
            echo "DNS not yet resolved (attempt $i/30), waiting 10 seconds..."
            sleep 10
          done

          # Final check
          nslookup "$DATABASE_HOST"

      - name: Wait for Database to be Ready
        run: |
          echo "Waiting for database to be active..."
          DATABASE_ID="${{ steps.terraform-apply.outputs.database_id }}"
          for i in {1..60}; do
            STATUS=$(curl -s -H "Authorization: Bearer ${{ secrets.LINODE_TOKEN }}" \
              "https://api.linode.com/v4/databases/postgresql/instances/${DATABASE_ID}" | \
              jq -r '.status')
            echo "Database status: $STATUS (attempt $i/60)"
            if [ "$STATUS" == "active" ]; then
              echo "Database is active and ready!"
              break
            fi
            if [ "$STATUS" == "failed" ]; then
              echo "Database provisioning failed!"
              exit 1
            fi
            sleep 10
          done

      - name: Terraform Apply - Create Databases and Users
        working-directory: ${{ inputs.terraform_dir }}
        run: |
          echo "Creating databases and users now that runner IP is whitelisted..."
          # Second apply: create databases and users with create_resources=true
          terraform apply -auto-approve -var="create_resources=true"

      - name: Display Database Connection Info
        run: |
          echo "=== PostgreSQL Database Provisioned ==="
          echo "Database ID: ${{ steps.terraform-apply.outputs.database_id }}"
          echo "Host: ${{ steps.terraform-apply.outputs.database_host }}"
          echo "Port: ${{ steps.terraform-apply.outputs.database_port }}"
          echo "Username: ${{ steps.terraform-apply.outputs.root_username }}"
          echo "Connection String: ${{ steps.terraform-apply.outputs.connection_string }}"
          echo "======================================="

      - name: Remove Runner IP from Database Allow List
        if: always()
        run: |
          DATABASE_ID="${{ steps.terraform-apply.outputs.database_id }}"
          RUNNER_IP="${{ steps.runner-ip.outputs.runner_ip }}"

          echo "Removing GitHub Runner IP ($RUNNER_IP) from database allow list for security..."

          # Get current allow list
          CURRENT_ALLOW_LIST=$(curl -s -H "Authorization: Bearer ${{ secrets.LINODE_TOKEN }}" \
            "https://api.linode.com/v4/databases/postgresql/instances/${DATABASE_ID}" | \
            jq -r '.allow_list[]' | grep -v "${RUNNER_IP}/32" | jq -R . | jq -s .)

          # Update database allow list (remove runner IP)
          curl -X PUT \
            -H "Authorization: Bearer ${{ secrets.LINODE_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"allow_list\": $CURRENT_ALLOW_LIST}" \
            "https://api.linode.com/v4/databases/postgresql/instances/${DATABASE_ID}"

          echo "Runner IP removed from allow list."
