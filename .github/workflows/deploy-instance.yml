name: Deploy Linode Instance (Reusable)

on:
  workflow_call:
    inputs:
      region:
        description: 'Linode Region'
        required: true
        type: string
      instance_type:
        description: 'Linode Instance Type'
        required: true
        type: string
      image:
        description: 'Linode Image'
        required: true
        type: string
      label:
        description: 'Linode Instance Label'
        required: true
        type: string
      environment:
        description: 'Deployment environment (e.g., test, prod)'
        required: true
        type: string
      terraform_dir:
        description: 'Directory containing Terraform configuration'
        required: false
        type: string
        default: './terraform/linode/instance'
    secrets:
      LINODE_TOKEN:
        description: 'Linode API Token'
        required: false
      ROOT_PASS:
        description: 'Root Password for Linode Instance'
        required: false
      SSH_KEYS:
        description: 'SSH Public Keys for Linode Instance'
        required: false
    outputs:
      instance_id:
        description: 'The ID of the created instance'
        value: ${{ jobs.deploy-instance.outputs.instance_id }}
      ip_address:
        description: 'The IP address of the created instance'
        value: ${{ jobs.deploy-instance.outputs.ip_address }}

jobs:
  deploy-instance:
    runs-on: ubuntu-latest
    if: ${{ inputs.environment != 'prod' || github.ref == 'refs/heads/main' }}
    environment: ${{ inputs.environment }}
    outputs:
      instance_id: ${{ steps.terraform-apply.outputs.instance_id }}
      ip_address: ${{ steps.terraform-apply.outputs.ip_address }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
          terraform_wrapper: false

      - name: Create Terraform Variables File
        working-directory: ${{ inputs.terraform_dir }}
        run: |
          cat > terraform.tfvars <<EOF
          linode_token = "${{ secrets.LINODE_TOKEN }}"
          region = "${{ inputs.region }}"
          type = "${{ inputs.instance_type }}"
          image = "${{ inputs.image }}"
          label = "${{ inputs.label }}"
          root_pass = "${{ secrets.ROOT_PASS }}"
          authorized_keys = ["${{ secrets.SSH_KEYS }}"]
          tags = ["${{ inputs.environment }}"]
          EOF

      - name: Terraform Init
        working-directory: ${{ inputs.terraform_dir }}
        run: terraform init

      - name: Terraform Apply
        id: terraform-apply
        working-directory: ${{ inputs.terraform_dir }}
        run: |
          terraform apply -auto-approve
          echo "instance_id=$(terraform output -raw id)" >> $GITHUB_OUTPUT
          echo "ip_address=$(terraform output -raw ip_address)" >> $GITHUB_OUTPUT