name: Deploy DNS Record (Reusable)

on:
  workflow_call:
    inputs:
      domain_id:
        description: 'The ID of the existing Linode domain'
        required: true
        type: number
      dns_records:
        description: 'A JSON array of DNS records, each with name, type, and value.'
        required: true
        type: string
      ttl_sec:
        description: 'The Time to Live (TTL) for the DNS record in seconds'
        required: false
        type: number
        default: 300
      terraform_dir:
        description: 'Directory containing Terraform configuration'
        required: false
        type: string
        default: 'modules/terraform/linode/dns'
    secrets:
      LINODE_TOKEN:
        description: 'Linode API Token'
        required: true
    outputs:
      record_id:
        description: 'The ID of the created DNS record'
        value: ${{ jobs.deploy-dns.outputs.record_id }}

jobs:
  deploy-dns:
    runs-on: ubuntu-latest
    outputs:
      record_id: ${{ steps.terraform-apply.outputs.record_id }}
    steps:
      - name: Checkout Terraform Modules
        uses: actions/checkout@v4
        with:
          repository: nexsware/modules
          path: modules

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          terraform_version: '1.6.0'
          terraform_wrapper: false

      - name: Validate DNS Records JSON
        run: |
          echo "Validating dns_records JSON: ${{ inputs.dns_records }}"
          echo "${{ inputs.dns_records }}" | jq . > /dev/null
          if [ $? -ne 0 ]; then
            echo "Error: dns_records is not valid JSON. Please provide a valid JSON array."
            exit 1
          fi

      - name: Create Terraform Variables File
        working-directory: ${{ inputs.terraform_dir }}
        run: |
          {
            echo "linode_token = \"${{ secrets.LINODE_TOKEN }}\""
            echo "domain_id = ${{ inputs.domain_id }}"
            echo "dns_records = ${{ inputs.dns_records }}"
            echo "ttl_sec = ${{ inputs.ttl_sec }}"
          } > terraform.tfvars

      - name: Terraform Init
        working-directory: ${{ inputs.terraform_dir }}
        run: terraform init

      - name: Terraform Apply
        id: terraform-apply
        working-directory: ${{ inputs.terraform_dir }}
        run: |
          terraform apply -auto-approve
          if [ "${{ inputs.create_dns_record }}" == "true" ]; then
            echo "record_id=$(terraform output -raw record_id 2>/dev/null || echo 'none')" >> $GITHUB_OUTPUT
          fi
